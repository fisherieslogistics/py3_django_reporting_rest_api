# https://github.com/svanoort/pyresttest
# act as a user who goes on a fishing trip
# test that can submit a trip event
# test that can submit 3 fishing events
# repeat for another vessel
# test that can retrieve the data and that ts all there
# test some things that should fail actually fail..


---
- config:
    - testset: "Test Fishing Trip"
    - generators:
      - 'today': {type: 'dategen', hours: 0}
      - 'tomorrow': {type: 'dategen', hours: 24}
      - 'geopoint': {type: 'geojsonpoint', lat: -45.879068, lon: 170.511046}


- test:
    name: "Login"
    method: POST
    headers: {"Content-Type": "application/json"}
    url: "/api-token-auth/"
    body: '{"username": "resttester", "password": "testrester"}'
    extract_binds:
        - 'jwt': {'jsonpath_mini': 'token'}

- template: &get
    headers: {template: {"Authorization": "JWT $jwt", "Content-Type": "application/json"}}
    method: GET

- template: &post
    headers: {template: {"Authorization": "JWT $jwt", "Content-Type": "application/json"}}
    method: POST

- test:
    name: "Create vessel"
    <<: *post
    body: '{"name": "USS Trump", "registration": 99}'
    url: "/rest-api/vessels/"
    extract_binds:
        - 'vessel_id': {'jsonpath_mini': 'id'}

- test:
    name: "Create port"
    <<: *post
    body: '{"name": "Trumps Wall", "location": "POINT(171.1535947 -44.3788682)"}'
    url: "/rest-api/ports/"
    extract_binds:
        - 'port_id': {'jsonpath_mini': 'id'}

- test:
    name: "List species"
    <<: *get
    url: "/rest-api/species/"
    extract_binds:
        - 'species_id': {'jsonpath_mini': 0.id}


- test:
    name: "Create a Trip"
    generator_binds: { t1: today,t2: tomorrow,t3: tomorrow, home: geopoint}
    <<: *post
    body: { template:
      '{
      "RAId": "de61697f-748f-498b-90a8-8afafa7e3b4f",
      "personInCharge": "Steeeve",
      "ETA": "$t2",
      "startTime": "$t1",
      "endTime": "$t3",
      "startLocation": "$home",
      "endLocation": "$home",
      "unloadPort": "$port_id",
      "vessel": "$vessel_id"
      }'
    }
    url: "/rest-api/trips/"
    extract_binds:
        - 'tripRAId': {'jsonpath_mini': 'RAId'}
        - 'trip_id': {'jsonpath_mini': 'id'}


- test:
    name: "Create a Fishing Event With Catches"
    generator_binds: { t1: today, t2: today, start: geopoint, end: geopoint, t3: today }
    <<: *post
    body: { template:
       '{
        "fishCatches": [{ "weightKgs": 100, "species": "$species_id" }],
        "numberInTrip": 1,
        "targetSpecies": "COC",
        "datetimeAtStart": "$t1",
        "datetimeAtEnd": "$t2",
        "committed": true,
        "locationAtStart": "$start",
        "locationAtEnd": "$end",
        "lineString": null,
        "eventSpecificDetails": "{\"fishingMethod\": \"H\", \"numberOfPeople\": 1}",
        "mitigationDeviceCodes": "[]",
        "vesselNumber": 123213123,
        "isVesselUsed": true,
        "completedDateTime": "$t3",
        "trip": "$trip_id",
        "RAId": "80293305-f619-4c38-8b21-09369ae6a4e3"
       }'
    }
    url: "/rest-api/fishingEvents/"
    extract_binds:
        - 'fishing_event_id': {'jsonpath_mini': 'id'}
    validators:
        - compare: {raw_body: , comparator: 'contains', expected: 'numberOfPeople'}


